---
title: "Concomitant PPI"
author: "Rebecca Hoyd"
date: "7/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(viridis)
source("00-paths.R")
```


# Load data

```{r}
corr <- read.csv("../data/CoRR_concomitent-meds.csv", stringsAsFactors = F)

ppi <- read.table("T:/Labs/Spakowicz/ppiio/data/curated/proton-pump-inhibitors.txt", 
                  stringsAsFactors = F, sep = "\t") %>%
    rename("medname" = "V1") %>%
    mutate(medclass = "PPI")

clin <- read.csv(file.path(paths$t.drive, "data", "clinical-with-OCids_limited.csv"), stringsAsFactors = F)
```

# Functions

```{r}
determine_ppis <- function(mednames, allmeds){
  meds.members <- lapply(mednames, function(x) as.data.frame(cbind(
    allmeds = unique(allmeds[grepl(x,
                                        allmeds,
                                        ignore.case = T)]),
    medname = x))) %>%
    bind_rows() %>%
    mutate(allmeds = as.character(allmeds),
           medname = as.character(medname),
           medclass = "ppi")
  
  return(meds.members)
}
  
```

# Defining ppi y/n

## Data manipulations

```{r}
corr.l <- corr %>%
  select("patient.id", "redcap_event_name", contains("agent")) %>%
  gather(contains("agent"), key = "mednumber", value = "allmeds") %>%
  filter(!is.na(allmeds) & allmeds != "")

alagents <- unique(corr.l$allmeds)
ppis.in.set <- determine_ppis(ppi$medname, alagents)


corr.ppilab <- corr.l %>%
  left_join(ppis.in.set) %>%
  mutate(ppi = ifelse(is.na(medclass), 0, 1))

corr.ppi.summarize <- corr.ppilab %>%
  group_by(patient.id, redcap_event_name) %>%
  summarise(ppi = sum(ppi)) %>%
  mutate(ppi = ifelse(ppi >= 1, 1, 0))
```

## Save

```{r}
write.csv(corr.ppi.summarize, file.path(paths$t.drive, "data", "patient_concommitant_ppis.csv"), row.names = F)
```

# Visualize timelines

## Get treatment groups

```{r}
ICI.meds <- as.data.frame(cbind(ici.name = c("CTLA4", rep("PD1", 4), "PDL1"),
                                ici.nums = c(50,55,56,65,82,85)),
                          stringsAsFactors = F)
corr.ppi.summarize <- read.csv(file.path(paths$t.drive, "data", "patient_concommitant_ppis.csv"), stringsAsFactors = F)
```

```{r}
test <- colnames(clin)
test[grep("the", test)]
sort(test)

clin.filt <- clin %>%
  select("patient.id", "sequence.id", "redcap_event_name", contains("tx_reg"))

clin.timein <- clin.filt %>%
  mutate(ici.nums = as.character(ifelse(!is.na(tx_reg_1_2), tx_reg_1_2, tx_reg_1))) %>%
  select(patient.id, sequence.id, redcap_event_name, ici.nums) %>%
  drop_na(ici.nums) %>%
  left_join(ICI.meds) %>%
  left_join(corr.ppi.summarize) %>%
  mutate(ppi = ifelse(is.na(ppi), 0, ppi),
         ici.name = ifelse(is.na(ici.name), "Not.ICI", ici.name),
         tpoint = gsub(".*_visit_(\\d).*", "\\1", redcap_event_name)) %>%
  filter(grepl("study", redcap_event_name))
```

```{r}
ggplot(clin.timein, aes(x = tpoint, y = as.factor(patient.id), shape = as.factor(ppi), color = ici.name)) +
  geom_point() +
  labs(y = "Patient", x = "Study Visit") +
  scale_color_viridis_d(name = "Treatment") +
  scale_shape(name = "PPI") +
  theme_bw() +
  ggsave("../figures/timeline_sample-points_treatment-ppi.png", height = 5, width = 5)
```