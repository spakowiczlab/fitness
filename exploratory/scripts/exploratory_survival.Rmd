---
title: "Survival tests"
output: html_document
date: "2023-08-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(survminer)
```


# Load data

```{r}
clin.withdate <- read.csv(paste0(paths$controlled, "/CoRR5512FITNESSCalcu_DATA_2022-10-04_1152.csv"), stringsAsFactors = F)
colnames(clin.withdate)[1] <- "id"
```

# Formatting

```{r}
idkey <- clin.withdate %>%
    select(id, sid_2) %>%
    drop_na()
```

```{r extract survival data}
survdat <- clin.withdate %>%
  select(id,enrollment_date, life_status, date_of_death, last_followup) %>%
  drop_na(life_status) %>%
  filter(enrollment_date != "") %>%
  # Mutate block for collecting dates
  mutate(date_of_death = ifelse(date_of_death == "", NA, date_of_death),
         last_followup = ifelse(last_followup == "", NA, last_followup),
         enddat = coalesce(date_of_death, last_followup),
         enddat = ifelse(life_status == 1, date_of_death, enddat),
         enddat = ifelse(life_status ==0 & is.na(last_followup), 
                         "2022-10-04", 
                         enddat)) %>%
  # Mutate block for formatting to days
  mutate(enddat = as.Date(enddat),
         enrollment_date = as.Date(enrollment_date),
         days = as.numeric(enddat - enrollment_date)) %>%
  select(id, life_status, days)

test <- clin.withdate %>%
  select(id,enrollment_date, life_status, date_of_death, last_followup) %>%
  drop_na(life_status) %>%
  filter(enrollment_date != "") %>%
  # Mutate block for collecting dates
  mutate(date_of_death = ifelse(date_of_death == "", NA, date_of_death),
         last_followup = ifelse(last_followup == "", NA, last_followup),
         date_of_death = as.Date(date_of_death),
         last_followup = as.Date(last_followup)) %>%
  filter(!is.na(date_of_death) & !is.na(last_followup)) %>%
  mutate(early_death = date_of_death < last_followup)

test %>%
  select(id, early_death)
```

```{r extract other variables}
clinvars <- clin.withdate %>%
  select(id, carg_score) %>%
  drop_na() %>%
  mutate(carg_high = ifelse(carg_score >=8 ,1, 0))
```

```{r final data object}
modin.surv <- survdat %>%
  left_join(clinvars) %>%
  drop_na(carg_high)
```

# Modelling

## CARG >= 8
```{r}
carg.res <- surv_fit(Surv(days, life_status) ~ carg_high, data = modin.surv)

cargplot <- ggsurvplot(carg.res, pval = T, risk.table = T, palette = c("black", "red"))
```

```{r}
png("../figures/survival-curve_CARG-ge8.png")
cargplot
dev.off()
```

